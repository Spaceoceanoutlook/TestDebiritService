# Test Deribit Service

Тестовое задание на позицию **Junior Backend Developer**.

Сервис предназначен для периодического получения цен криптовалют с биржи **Deribit**, сохранения их в базу данных и предоставления внешнего API для работы с этими данными.

---

## Функциональность

### 1. Фоновый сбор данных
- Каждую минуту сервис получает **index price** для валют:
  - `btc_usd`
  - `eth_usd`
- Источник данных — публичное API Deribit
- Для периодического выполнения используется **Celery + Celery Beat**

### 2. Хранение данных
- Используется **PostgreSQL**
- Для каждой записи сохраняется:
  - тикер валюты
  - цена
  - UNIX timestamp

### 3. HTTP API (FastAPI)
Реализованы GET-эндпоинты:
- получение всех сохранённых данных по тикеру
- получение последней цены валюты
- получение цен валюты с фильтрацией по диапазону дат

Все эндпоинты принимают обязательный query-параметр `ticker`.

---

## Архитектура проекта

Сервис состоит из нескольких компонентов:

- **FastAPI** — HTTP API для доступа к данным
- **Celery Worker** — выполнение фоновых задач
- **Celery Beat** — планировщик периодических задач
- **Redis** — брокер сообщений для Celery
- **PostgreSQL** — основная база данных

### Общая схема работы

1. Celery Beat по расписанию (раз в минуту) отправляет задачу в Redis
2. Celery Worker получает задачу и:
   - запрашивает цены у Deribit
   - сохраняет данные в PostgreSQL
3. FastAPI предоставляет API для чтения сохранённых данных

---

## Используемые технологии

- Python 3.13
- FastAPI
- Celery
- Celery Beat
- Redis
- PostgreSQL
- SQLAlchemy
- aiohttp
- Docker / Docker Compose

---

## Запуск проекта

### 1. Клонирование репозитория

```bash
git clone https://github.com/Spaceoceanoutlook/TestDeribitService.git
```
Открыть проект в редакторе, в корне проекта создать файл `.env` и добавить следующие переменные:
```
POSTGRES_USER=user
POSTGRES_PASSWORD=password
POSTGRES_HOST=db
POSTGRES_PORT=5432
POSTGRES_DB=prices

DERIBIT_BASE_URL=https://www.deribit.com/api/v2
TICKERS=["btc_usd","eth_usd"]
```
В системе должен быть установлен poetry

Установка библиотек:
```bash 
poetry install
```

Для корректной работы приложения, версия python должны быть < 3.14

Если глобальная версия python >= 3.14, то установить 3.13.0 через pyenv, после чего выполнить
```bash 
poetry env use ~/.pyenv/versions/3.13.0/bin/python
```

Активировать виртуальное окружение:
```bash 
poetry env activate
```
Запустить приложение
```bash 
docker compose up --build -d
```
Создать и применить миграцию:
```bash 
docker compose exec api alembic revision --autogenerate -m "init"
docker compose exec api alembic upgrade head
```

После старта сервиса каждую минуту в базе данных сохраняются текущие цены btc_usd и eth_usd с биржи debirit, получить их можно через API `http://127.0.0.1:8000/docs`

## Design Decisions

### Использование Celery
Celery выбран для выполнения фоновых задач, так как он позволяет:
- не блокировать HTTP API
- выполнять периодические задачи
- масштабировать worker-ы независимо от API

### Использование Celery Beat
Celery Beat используется для планирования периодических задач и запуска сбора цен с заданным интервалом.

### Использование Redis
Redis используется в качестве брокера сообщений для Celery, так как:
- прост в настройке
- обеспечивает быструю передачу задач
- хорошо интегрируется с Celery

### Использование aiohttp
Для обращения к Deribit API используется `aiohttp`, так как:
- он поддерживает асинхронные HTTP-запросы
- снижает накладные расходы при сетевых вызовах

### Async внутри Celery
Celery-задачи являются синхронными.  
Для использования асинхронного HTTP-клиента внутри задачи применяется явное создание и управление event loop.

### Разделение Celery Worker и Beat
Celery Worker и Celery Beat запускаются в отдельных контейнерах, что соответствует рекомендуемой архитектуре Celery и повышает отказоустойчивость системы.

---

## Тестирование

Для основных HTTP-эндпоинтов реализованы unit-тесты с использованием `pytest` и отдельной тестовой базы данных SQLite.
